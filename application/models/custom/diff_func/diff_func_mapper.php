<?phpclass Diff_func_mapper extends MY_Model {  // table constants  const TABLE_CATALOG_SECTION       = 'catalog_section';  const TABLE_CATALOG_CATEGORY      = 'catalog_category';  const TABLE_CATALOG_CURRENCY      = 'catalog_currency';  const TABLE_CATALOG_ITEM          = 'catalog_item';  const TABLE_CATALOG_ITEM_IMAGES   = 'catalog_item_images';  const TABLE_CATALOG_ITEM_LINKS    = 'catalog_item_links';  const TABLE_CATALOG_USER_FIELDS   = 'catalog_user_fields';  const TABLE_CATALOG_USER_VALUES   = 'catalog_user_values';  const TABLE_CATALOG_SIMILAR_ITEMS = 'catalog_similar_items';  const TABLE_IMAGES                = 'images';  const TABLE_PAGES                 = 'pages';  // class for result object  const CLASS_SECTION  = 'Catalog_Section';  const CLASS_CATEGORY = 'Catalog_Category';  const CLASS_ITEM     = 'Catalog_Item';  public function  __construct ()  {    parent::__construct();    $this->_coupons_url = 'http://www.apolonka.ru/xml/coupons.xml';    $this->_categories_url = 'http://www.apolonka.ru/xml/categories.xml';    $this->_delivery_url = 'http://www.apolonka.ru/xml/delivery.xml';    $this->_object_photos_url = 'http://www.apolonka.ru/xml/object_photos.xml';    $this->_products_url = 'http://www.apolonka.ru/xml/products.xml';    $this->_p_brands_url = 'http://www.apolonka.ru/xml/p_brands.xml';    $this->_p_colors_url = 'http://www.apolonka.ru/xml/p_colors.xml';    $this->_p_material_url = 'http://www.apolonka.ru/xml/p_material.xml';    $this->_p_sizes_url = 'http://www.apolonka.ru/xml/p_sizes.xml';  }         public function get_catalog_categories_xml(){        //$document = new SimpleXMLElement($xmlstr);        $document = simplexml_load_file($this->_coupons_url);        return $document;    }                private function get_coupons_xml(){        $document = simplexml_load_file($this->_coupons_url);                foreach ($document->database->table_data->row as $row){            $coupons=array();                                foreach ($row->field as $field){                $coupons[(string)$field['name']]=(string)$field;            }                               $this->db->select('*');            $this->db->from('coupons');            $this->db->where('id', $coupons['id']);            $result=$this->db->get()->row_array();                        if($result != null){                $this->db->where('id', $coupons['id']);                $this->db->update('coupons', $coupons);             }            else{                $this->db->insert('coupons', $coupons);             }                                  unset($coupons);        }               }    private function get_p_brands_xml(){        $document = simplexml_load_file($this->_p_brands_url);                foreach ($document->database->table_data->row as $row){            $p_brands=array();                                foreach ($row->field as $field){                $p_brands[(string)$field['name']]=(string)$field;            }                               $this->db->select('*');            $this->db->from('p_brands');            $this->db->where('id', $p_brands['id']);            $result=$this->db->get()->row_array();                        if($result != null){                $this->db->where('id', $p_brands['id']);                $this->db->update('p_brands', $p_brands);             }            else{                $this->db->insert('p_brands', $p_brands);             }                                  unset($p_brands);        }               }        private function get_p_colors_xml(){        $document = simplexml_load_file($this->_p_colors_url);                foreach ($document->database->table_data->row as $row){            $p_colors=array();                                foreach ($row->field as $field){                $p_colors[(string)$field['name']]=(string)$field;            }                               $this->db->select('*');            $this->db->from('p_colors');            $this->db->where('id', $p_colors['id']);            $result=$this->db->get()->row_array();                        if($result != null){                $this->db->where('id', $p_colors['id']);                $this->db->update('p_colors', $p_colors);             }            else{                $this->db->insert('p_colors', $p_colors);             }                                  unset($p_colors);        }               }        private function get_p_material_xml(){        $document = simplexml_load_file($this->_p_material_url);                foreach ($document->database->table_data->row as $row){            $p_material=array();                                foreach ($row->field as $field){                $p_material[(string)$field['name']]=(string)$field;            }                               $this->db->select('*');            $this->db->from('p_material');            $this->db->where('id', $p_material['id']);            $result=$this->db->get()->row_array();                        if($result != null){                $this->db->where('id', $p_material['id']);                $this->db->update('p_material', $p_material);             }            else{                $this->db->insert('p_material', $p_material);             }                                  unset($p_material);        }               }        private function get_p_sizes_xml(){        $document = simplexml_load_file($this->_p_sizes_url);                foreach ($document->database->table_data->row as $row){            $p_sizes=array();                                foreach ($row->field as $field){                $p_sizes[(string)$field['name']]=(string)$field;            }                               $this->db->select('*');            $this->db->from('p_sizes');            $this->db->where('id', $p_sizes['id']);            $result=$this->db->get()->row_array();                        if($result != null){                $this->db->where('id', $p_sizes['id']);                $this->db->update('p_sizes', $p_sizes);             }            else{                $this->db->insert('p_sizes', $p_sizes);             }                                  unset($p_sizes);        }               }    private function get_categories_xml(){        $document = simplexml_load_file($this->_categories_url);                foreach ($document->database->table_data->row as $row){            $categories1=array();                    $categories2=array();                        foreach ($row->field as $field){                $categories1[(string)$field['name']]=(string)$field;            }                               if($categories1['public'] == 1){                            $categories2['id'] = $categories1['id'];                $categories2['title'] = $categories1['name'];                $categories2['parent_category_id'] = $categories1['own'];                $categories2['priority'] = $categories1['sort'];                                $categories2['parent_section_id'] = 15;                $this->db->select('*');                $this->db->from('catalog_category');                $this->db->where('id', $categories2['id']);                $result=$this->db->get()->row_array();                                if($result != null){                    $this->db->where('id', $categories2['id']);                    $this->db->update('catalog_category', $categories2);                 }                else{                    $this->db->insert('catalog_category', $categories2);                 }                            }            unset($categories1);            unset($categories2);        }               }        private function get_delivery_xml(){        $document = simplexml_load_file($this->_delivery_url);                foreach ($document->database->table_data->row as $row){            $delivery=array();                                foreach ($row->field as $field){                $delivery[(string)$field['name']]=(string)$field;            }                               $this->db->select('*');            $this->db->from('delivery');            $this->db->where('id', $delivery['id']);            $result=$this->db->get()->row_array();                        if($result != null){                $this->db->where('id', $delivery['id']);                $this->db->update('delivery', $delivery);             }            else{                $this->db->insert('delivery', $delivery);             }                                  unset($delivery);        }               }        private function get_object_photos_xml(){        $document = simplexml_load_file($this->_object_photos_url);                foreach ($document->database->table_data->row as $row){            $object_photos=array();                    $images=array();            $catalog_item_images=array();            foreach ($row->field as $field){                $object_photos[(string)$field['name']]=(string)$field;            }                                           $images['filename'] = $object_photos['filename'];            $images['id'] = $object_photos['id'];            $images['size'] = 17;            $images['width'] = 310;            $images['height'] = 304;            $images['type'] = 'jpeg';                        $catalog_item_images['id'] = $object_photos['id'];            $catalog_item_images['item_id'] = $object_photos['obj_id'];            $catalog_item_images['image_id'] = $object_photos['id'];            $catalog_item_images['priority'] = $object_photos['sort'];            $this->db->select('*');            $this->db->from('images');            $this->db->where('id', $images['id']);            $result=$this->db->get()->row_array();                                    if($result != null){                $this->db->where('id', $images['id']);                $this->db->update('images', $images);                                 $this->db->where('id',$catalog_item_images['id']);                $this->db->update('catalog_item_images', $catalog_item_images);             }            else{                $this->db->insert('images', $images);                 $this->db->insert('catalog_item_images', $catalog_item_images);             }                      unset($catalog_item_images);            unset($object_photos);            unset($images);        }               }        private function get_products(){        $document = simplexml_load_file($this->_products_url);                foreach ($document->database->table_data->row as $row){            $products=array();                    $catalog_item=array();            $catalog_item_links=array();            $catalog_similar_items=array();            foreach ($row->field as $field){                $products[(string)$field['name']]=(string)$field;            }                                       $catalog_item['id'] = $products['id'];            $catalog_item['section_id'] = 15;            $catalog_item['title'] = $products['name'];            $catalog_item['article'] = $products['articul'];               $catalog_item['adddesc'] = $products['adddesc'];                        $catalog_item['brand'] = $products['brand'];            $catalog_item['colors'] = $products['colors'];            $catalog_item['price'] = $products['price'];            $catalog_item['discount_percent'] = $products['discount'];                        $catalog_item['is_deleted'] = !$products['public'];                        $catalog_item['size'] = $products['size'];            $catalog_item['material'] = $products['material'];            $catalog_item['description'] = $products['description'];                        $catalog_item_links['id'] = $products['id'];            $catalog_item_links['category_id'] = $products['cat_id'];            $catalog_item_links['item_id'] = $products['id'];                        $catalog_similar_items['id'] = $products['id'];            $catalog_similar_items['sim_item_id'] = $products['partners_ids'];            $catalog_similar_items['item_id'] = $products['id'];                        if($products['instock'] >= 1){                $catalog_item['in_stock'] = 1;            }            else{$catalog_item['in_stock']=0;}                        if($products['new'] >= 1){                $catalog_item['is_bestseller'] = 1;            }            else{$catalog_item['is_bestseller']=0;}                        if($products['sale'] >= 1){             $catalog_item['is_sale'] = 1;            }            else{$catalog_item['is_sale']=0;}            $this->db->select('*');            $this->db->from('catalog_item');            $this->db->where('id', $catalog_item['id']);            $result=$this->db->get()->row_array();                        if($result != null){                $this->db->where('id', $catalog_item['id']);                $this->db->update('catalog_item', $catalog_item);                                 $this->db->where('id', $catalog_item_links['id']);                $this->db->update('catalog_item_links', $catalog_item_links);                                 $this->db->where('id', $catalog_similar_items['id']);                $this->db->update('catalog_similar_items', $catalog_similar_items);             }            else{                $this->db->insert('catalog_item', $catalog_item);                 $this->db->insert('catalog_item_links', $catalog_item_links);                 $this->db->insert('catalog_similar_items', $catalog_similar_items);             }                            if ($catalog_item['is_deleted'] == 0){                   $this->db->select('*');                $this->db->from('catalog_item_images');                $this->db->where('item_id', $catalog_item['id']);                $this->db->where('is_main', 1);                $result2=$this->db->get()->row_array();                                if($result2 == null){                    $this->db->select('*');                    $this->db->from('catalog_item_images');                    $this->db->where('item_id', $catalog_item['id']);                    $this->db->order_by('priority', 'asc');                     $result3=$this->db->get()->row_array();                    if($result3 != null){                        $result3['is_main']=1;                        $this->db->where('id', $result3['id']);                        $this->db->update('catalog_item_images', $result3);                     }                }            }                        unset($products);            unset($catalog_item);            unset($catalog_item_links);                    unset($catalog_similar_items);        }               }    public function get_xml(){       // $this->parser();      //  $this->get_coupons_xml();         $this->get_categories_xml();         $this->get_delivery_xml();               $this->get_p_brands_xml();        $this->get_p_colors_xml();        $this->get_p_material_xml();        $this->get_p_sizes_xml();        $this->get_object_photos_xml();        $this->get_products();    }    //новинки    public function get_new_product($numbs){        $this->db->select('*');        $this->db->from('catalog_item');        $this->db->where('is_deleted', 0);        $this->db->where('is_bestseller', 1);        $this->db->where('in_stock', 1);        $this->db->order_by('id', 'desc');                 $this->db->limit($numbs);        return $this->db->get()->result(self::CLASS_ITEM);    }    //товары со скидкой    public function get_sale_product($numbs){        $this->db->select('*');        $this->db->from('catalog_item');        $this->db->where('is_deleted', 0);        $this->db->where('is_sale', 1);        $this->db->where('in_stock', 1);        $this->db->order_by('id', 'desc');                 $this->db->limit($numbs);        return $this->db->get()->result(self::CLASS_ITEM);    }    //список категорий нулевого уровня    public function get_category_null(){        $this->db->select('*');        $this->db->from('catalog_category');        $this->db->where('is_deleted', 0);        $this->db->where('parent_category_id', 0);        $this->db->order_by('priority', 'asc');                 return $this->db->get()->result(self::CLASS_CATEGORY);    }    public function get_category_first($id){        $this->db->select('*');        $this->db->from('catalog_category');        $this->db->where('is_deleted', 0);        $this->db->where('parent_category_id', $id);        $this->db->order_by('priority', 'asc');                 return $this->db->get()->result(self::CLASS_CATEGORY);    }    public function get_pages($parent_id){            $result = array();        $this->db->select('id, url, title, show_alias, alias');        $this->db->from('pages');        $this->db->where('parent_id',$parent_id);        $this->db->where('show',1);        $this->db->order_by("priority", "asc");         $result = $this->db->get()->result_array();        $result2 = array();        $this->db->select('parent_id, id, title, url, show_alias, alias');        $this->db->from('pages');        $this->db->where('id',$parent_id);        $result2 = $this->db->get()->row_array();        for($i=0;$i<5;$i++){            if($result2){                if($result2['parent_id'] == 0){                $result[0]['parent'] = $result2['title'];                $result[0]['parent_url'] = $result2['url'];                return $result;                }            }            $this->db->select('parent_id, id, title, url, show_alias, alias');            $this->db->from('pages');            $this->db->where('id',$result2['parent_id']);            $result2 = $this->db->get()->row_array();        }    return $result;    }    public function delivery(){        $this->db->select('*');        $this->db->from('delivery');        $this->db->order_by('sort', 'asc');             return $this->db->get()->result_array();    }    public function brands(){        $this->db->select('*');        $this->db->from('p_brands');        $this->db->order_by('name', 'asc');             return $this->db->get()->result_array();    }    public function colours(){        $this->db->select('*');        $this->db->from('p_colors');        $this->db->order_by('id', 'asc');             return $this->db->get()->result_array();    }    public function materials(){        $this->db->select('*');        $this->db->from('p_material');        $this->db->order_by('id', 'asc');             return $this->db->get()->result_array();    }    public function sizes(){        $this->db->select('*');        $this->db->from('p_sizes');        $this->db->order_by('id', 'asc');             return $this->db->get()->result_array();    }    public function get_brand($id){        $this->db->select('name');        $this->db->from('p_brands');        $this->db->where('id', $id);             return $this->db->get()->row();    }    public function parser(){        $this->db->select('*');        $this->db->from('catalog_item_images');        $result2=$this->db->get()->result_array();        foreach($result2 as $index=>$res){            $res['is_main']=0;            $this->db->where('id', $res['id']);            $this->db->update('catalog_item_images', $res);        }    }}